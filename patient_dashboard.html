<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Patient Medicine Tracker â€” Premium UI</title>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-1: #0f1724;
      --bg-2: #0b1220;
      --glass: rgba(255, 255, 255, 0.06);
      --accentA: #00c6ff;
      --accentB: #0072ff;
      --success: #22c55e;
      --muted: rgba(255, 255, 255, 0.6);
      --danger: #ef4444;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      font-family: "Poppins", sans-serif;
      background: linear-gradient(120deg, var(--bg-1), var(--bg-2));
      color: #fff;
    }

    .wrap {
      width: 95%;
      max-width: 1150px;
      margin: 36px auto;
      padding: 24px;
      border-radius: 20px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.02));
      box-shadow: 0 12px 40px rgba(2, 6, 23, 0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: all .3s ease;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .title h1 {
      margin: 0;
      font-size: 1.8rem;
      background: linear-gradient(90deg, var(--accentA), var(--accentB));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .title p {
      margin: 3px 0 0;
      color: var(--muted);
      font-size: 0.95rem;
    }

    /* ðŸ”´ Stylish Logout Button */
    .logout-btn {
      background: var(--danger);
      border: none;
      color: #fff;
      font-weight: 600;
      font-size: 0.95rem;
      padding: 10px 18px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 14px rgba(239, 68, 68, 0.3);
    }

    .logout-btn:hover {
      background: #dc2626;
      transform: scale(1.05);
      box-shadow: 0 6px 18px rgba(239, 68, 68, 0.5);
    }

    .top-panel {
      display: flex;
      gap: 18px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 22px;
    }

    .info,
    .progress-wrap,
    .patient-card {
      border-radius: 14px;
      background: var(--glass);
      border: 1px solid rgba(255, 255, 255, 0.05);
      padding: 18px;
      transition: all 0.3s ease;
    }

    .info:hover,
    .progress-wrap:hover,
    .patient-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    .info h2 {
      margin: 0 0 6px;
      color: var(--accentB)
    }

    .info p {
      margin: 6px 0;
      color: var(--muted);
      font-weight: 500
    }

    .progress-wrap,
    .patient-card {
      flex: 0 0 250px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.02));
    }

    .progress-number {
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(90deg, var(--accentA), var(--accentB));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: pulse 2s infinite ease-in-out;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
        transform: scale(1)
      }

      50% {
        opacity: 0.85;
        transform: scale(1.05)
      }
    }

    .progress-bar {
      width: 100%;
      height: 10px;
      background: rgba(255, 255, 255, 0.06);
      border-radius: 999px;
      margin-top: 10px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accentA), var(--accentB));
      border-radius: 999px;
      transition: width 0.5s ease-in-out;
    }

    .patient-card h3 {
      margin: 8px 0 4px;
      font-size: 1.1rem;
      color: var(--accentB);
    }

    .patient-card p {
      color: var(--muted);
      font-size: 0.95rem;
      margin: 2px 0;
    }

    .days-grid {
      margin-top: 6px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 18px;
    }

    .day-card {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.01));
      border-radius: 14px;
      padding: 14px;
      border: 1px solid rgba(255, 255, 255, 0.04);
      transition: all .28s ease;
    }

    .day-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.45);
    }

    .day-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px
    }

    .day-head h3 {
      margin: 0;
      font-size: 1.05rem;
      color: var(--accentB)
    }

    .badge {
      font-weight: 700;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: .82rem
    }

    .badge.pending {
      background: rgba(255, 80, 80, 0.12);
      color: #ff8b8b;
      border: 1px solid rgba(255, 80, 80, 0.08)
    }

    .badge.success {
      background: rgba(34, 197, 94, 0.12);
      color: var(--success);
      border: 1px solid rgba(34, 197, 94, 0.08)
    }

    .times {
      display: flex;
      flex-wrap: wrap;
      gap: 10px
    }

    .time-item {
      flex: 1 1 calc(50% - 8px);
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 9px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.02);
    }

    .time-item .lbl {
      font-size: .95rem;
      color: var(--muted)
    }

    .time-item input {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: var(--accentB)
    }

    .day-complete {
      background: linear-gradient(180deg, rgba(34, 197, 94, 0.06), rgba(34, 197, 94, 0.04));
      border-color: rgba(34, 197, 94, 0.12) !important;
    }

    .footer {
      margin-top: 20px;
      text-align: center;
      color: var(--muted);
      font-size: .95rem
    }

    @media (max-width:680px) {
      .top-panel {
        flex-direction: column;
        align-items: stretch
      }

      .progress-wrap,
      .patient-card {
        width: 100%
      }
    }

    .congrats {
      text-align: center;
      padding: 60px 30px;
      border-radius: 20px;
      background: linear-gradient(145deg, rgba(0, 198, 255, 0.15), rgba(34, 197, 94, 0.15));
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
      animation: fadeIn 1s ease-in-out;
    }

    .congrats h2 {
      font-size: 2rem;
      margin-bottom: 12px;
      background: linear-gradient(90deg, var(--accentA), var(--accentB));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .congrats p {
      color: var(--muted);
      font-size: 1rem
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.95)
      }

      to {
        opacity: 1;
        transform: scale(1)
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div class="title">
        <h1>MediEye â€” Medicine Tracker</h1>
        <p>Personalized schedule â€¢ Track each dose â€¢ Secure & reliable</p>
      </div>
      <!-- ðŸ”´ Logout Button -->
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>

    <div class="top-panel">
      <div class="info">
        <h2 id="medicineTitle">Dolo 650</h2>
        <p><strong>Disease:</strong> Fever</p>
        <p><strong>Duration:</strong> <span id="durationDays">5</span> days</p>
        <p><strong>Dosage:</strong> Morning Â· Afternoon Â· Evening Â· Night</p>
      </div>


      <div class="patient-card">
        <div style="font-size:0.9rem;color:var(--muted)">Patient</div>
        <h3 id="patientName">John Doe</h3>
        <p>Age: 27</p>
        <p>Email: john.doe@gmail.com</p>
      </div>
    </div>

    <div id="daysGrid"></div>

    <!-- For overall progress bar -->
    <div class="progress-bar" style="height: 10px; background: #eee; width: 100%;">
      <div id="progressFill" style="height: 100%; width: 0%; background: green;"></div>
    </div>
    <span id="progressNumber">0%</span>
  </div>

  <script>
    // ðŸ”‘ Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCd9uDRng_yMuMzqLhqrPs3Quht_lekbF0",
      authDomain: "medieye-8d798.firebaseapp.com",
      databaseURL: "https://medieye-8d798-default-rtdb.asia-southeast1.firebasedatabase.app/",
      projectId: "medieye-8d798",
      storageBucket: "medieye-8d798.firebasestorage.app",
      messagingSenderId: "967976625417",
      appId: "1:967976625417:web:00eed975b183e6d1e91fd8"
    };
  
    // Global variables (will be set after data loads)
    let TOTAL_DAYS = 5;
    let ACTIVE_TIMES = []; // Will be set based on dosages
    let state = {};
    const TIME_KEY_MAP = {
      Morning: 'morning',
      Afternoon: 'afternoon',
      Evening: 'evening',
      Night: 'night'
    };
    const ALL_TIMES = ["Morning", "Afternoon", "Evening", "Night"];
  
    async function loadData() {
      const urlParams = new URLSearchParams(window.location.search);
      const userid = urlParams.get('userId');
  
      if (!userid) {
        alert("User ID is missing in URL.");
        return;
      }
  
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      const database = firebase.database();
  
      try {
        const snapshot = await database.ref('patients/' + userid).once('value');
        if (!snapshot.exists()) {
          alert("User doesn't exist.");
          return;
        }
  
        const userData = snapshot.val();
        console.log("Loaded patient data:", userData);
  
        // Update top panel
        const infoPanel = document.querySelector(".top-panel");
        if (infoPanel) {
          infoPanel.innerHTML = `
            <div class="info">
              <h2 id="medicineTitle">${userData.medicine || 'N/A'}</h2>
              <p><strong>Disease:</strong> ${userData.disease || 'N/A'}</p>
              <p><strong>Duration:</strong> <span id="durationDays">${userData.days || 'N/A'}</span> days</p>
              <p><strong>Dosage:</strong> ${ACTIVE_TIMES.join(' Â· ') || 'None'}</p>
            </div>
            <div class="progress-wrap">
              <div style="font-size:0.9rem;color:var(--muted)">Overall Completion</div>
              <div class="progress-number" id="progressNumber">0%</div>
              <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
            </div>
            <div class="patient-card">
              <div style="font-size:0.9rem;color:var(--muted)">Patient</div>
              <h3 id="patientName">${userData.name || 'N/A'}</h3>
              <p>Age: ${userData.age || 'N/A'}</p>
              <p>Email: ${userData.email || 'N/A'}</p>
            </div>
          `;
        }
  
        // Set global config from Firebase
        TOTAL_DAYS = parseInt(userData.days) || 5;
        const prescribed = userData.dosages || {};
  
        // âœ… Build ACTIVE_TIMES (only times with dosage > 0)
        ACTIVE_TIMES = ALL_TIMES.filter(time => {
          const key = TIME_KEY_MAP[time];
          return prescribed[key] > 0;
        });
  
        // Initialize state
        const completed = userData.completedDosages || {};
        state = {};
        for (let d = 1; d <= TOTAL_DAYS; d++) {
          state[d] = { times: {} };
          ACTIVE_TIMES.forEach(time => {
            state[d].times[time] = completed[`${d}-${time}`] || false;
          });
        }
  
        renderUI();
        updateOverall();
  
      } catch (error) {
        console.error("Firebase error:", error);
        alert("Failed to load patient data. Check console.");
      }
    }
  
    function renderUI() {
      const daysGrid = document.getElementById('daysGrid');
      if (!daysGrid) return;
      daysGrid.innerHTML = '';
  
      for (let d = 1; d <= TOTAL_DAYS; d++) {
        daysGrid.appendChild(createDayCard(d));
      }
    }
  
    function createDayCard(day) {
      const card = document.createElement('div');
      card.className = 'day-card';
      card.dataset.day = day;
      card.innerHTML = `
        <div class="day-head">
          <h3>Day ${day}</h3>
          <span class="badge pending" id="badge-${day}">Pending</span>
        </div>
        <div class="times">${
          ACTIVE_TIMES.map(t => `
            <label class="time-item">
              <input type="checkbox" data-day="${day}" data-time="${t}" ${state[day].times[t] ? 'checked' : ''}>
              <div class="lbl">${t}</div>
            </label>`).join('')
        }</div>
        <div style="margin-top:12px">
          <div class="progress-bar" style="height:8px;background:rgba(255,255,255,0.03)">
            <div class="progress-fill-day" id="pf-${day}" style="height:100%;width:0%;background:linear-gradient(90deg,var(--accentA),var(--accentB));transition:width .35s ease"></div>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
            <div style="font-size:.92rem;color:var(--muted)" id="pctText-${day}">0% complete</div>
            <div id="dayStatus-${day}" style="font-weight:700"></div>
          </div>
        </div>
      `;
  
      card.querySelectorAll('input').forEach(chk => {
        chk.addEventListener('change', onCheckboxChange);
      });
  
      // Initialize progress
      const pct = getDayProgressPercent(day);
      const fillEl = document.getElementById(`pf-${day}`);
      const textEl = document.getElementById(`pctText-${day}`);
      if (fillEl) fillEl.style.width = `${pct}%`;
      if (textEl) textEl.textContent = `${pct}% complete`;
  
      const badge = document.getElementById(`badge-${day}`);
      const cardEl = document.querySelector(`.day-card[data-day="${day}"]`);
      const dayStatus = document.getElementById(`dayStatus-${day}`);
  
      if (pct === 100) {
        if (badge) { badge.className = 'badge success'; badge.textContent = 'Success'; }
        if (cardEl) cardEl.classList.add('day-complete');
        if (dayStatus) dayStatus.textContent = 'âœ…';
      }
  
      return card;
    }
  
    function getDayProgressPercent(day) {
      if (ACTIVE_TIMES.length === 0) return 0;
      const checked = ACTIVE_TIMES.filter(t => state[day].times[t]).length;
      return Math.round((checked / ACTIVE_TIMES.length) * 100);
    }
  
    function onCheckboxChange(e) {
      const day = +e.target.dataset.day;
      const time = e.target.dataset.time;
      state[day].times[time] = e.target.checked;
  
      const pct = getDayProgressPercent(day);
      const fillEl = document.getElementById(`pf-${day}`);
      const textEl = document.getElementById(`pctText-${day}`);
      if (fillEl) fillEl.style.width = `${pct}%`;
      if (textEl) textEl.textContent = `${pct}% complete`;
  
      const badge = document.getElementById(`badge-${day}`);
      const card = document.querySelector(`.day-card[data-day="${day}"]`);
      const dayStatus = document.getElementById(`dayStatus-${day}`);
  
      if (pct === 100) {
        if (badge) { badge.className = 'badge success'; badge.textContent = 'Success'; }
        if (card) card.classList.add('day-complete');
        if (dayStatus) dayStatus.textContent = 'âœ…';
      } else {
        if (badge) { badge.className = 'badge pending'; badge.textContent = 'Pending'; }
        if (card) card.classList.remove('day-complete');
        if (dayStatus) dayStatus.textContent = '';
      }
  
      updateOverall();
      saveToFirebase();
    }
  
    function updateOverall() {
      if (ACTIVE_TIMES.length === 0) return;
  
      let checked = 0, total = 0;
      for (let d = 1; d <= TOTAL_DAYS; d++) {
        ACTIVE_TIMES.forEach(() => {
          total++;
          if (state[d].times) {
            // Already filtered, so just count
            // We rely on getDayProgressPercent logic
          }
        });
      }
      // Simpler: total = TOTAL_DAYS * ACTIVE_TIMES.length
      total = TOTAL_DAYS * ACTIVE_TIMES.length;
      for (let d = 1; d <= TOTAL_DAYS; d++) {
        checked += ACTIVE_TIMES.filter(t => state[d].times[t]).length;
      }
  
      const pct = total ? Math.round((checked / total) * 100) : 0;
      const progressFill = document.getElementById('progressFill');
      const progressNumber = document.getElementById('progressNumber');
      if (progressFill) progressFill.style.width = `${pct}%`;
      if (progressNumber) progressNumber.textContent = `${pct}%`;
  
      if (pct === 100) showCongrats();
    }
  
    function showCongrats() {
      const grid = document.getElementById('daysGrid');
      if (grid) {
        grid.innerHTML = `
          <div class="congrats">
            <h2>ðŸŽ‰ Congratulations!</h2>
            <p>You've successfully completed your entire medication course.<br>Stay healthy & hydrated ðŸ’§</p>
          </div>
        `;
      }
    }
  
    async function saveToFirebase() {
      const urlParams = new URLSearchParams(window.location.search);
      const userid = urlParams.get('userId');
      if (!userid) return;
  
      const completedDosages = {};
      for (let d = 1; d <= TOTAL_DAYS; d++) {
        ACTIVE_TIMES.forEach(t => {
          completedDosages[`${d}-${t}`] = state[d].times[t] || false;
        });
      }
  
      try {
        await firebase.database().ref(`patients/${userid}`).update({ completedDosages });
        console.log("âœ… Progress saved to Firebase");
      } catch (err) {
        console.error("âŒ Save failed:", err);
      }
    }
  
    document.getElementById("logoutBtn")?.addEventListener("click", () => {
      window.location.href = "index.html";
    });
  
    // Start when DOM is ready
    document.addEventListener("DOMContentLoaded", loadData);
  </script>
</body>

</html>
