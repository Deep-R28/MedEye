<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MediEye | Add Patient</title>

  <!-- Add Firebase SDKs in your HTML head -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }

    body {
      display: flex;
      background: #f5f7fa;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 220px;
      background: #fff;
      border-right: 1px solid #ddd;
      padding: 20px;
    }

    .sidebar h2 {
      font-size: 20px;
      margin-bottom: 20px;
    }

    .sidebar ul {
      list-style: none;
    }

    .sidebar ul li {
      margin: 12px 0;
    }

    .sidebar ul li a {
      text-decoration: none;
      color: #333;
      font-weight: 500;
    }

    .sidebar ul li a.active {
      color: #4361ee;
      font-weight: 700;
    }

    /* Main */
    .main {
      flex: 1;
      padding: 20px;
    }

    /* Summary Cards */
    .summary {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      text-align: center;
    }

    .card h3 {
      font-size: 22px;
      margin-bottom: 8px;
    }

    .card p {
      font-size: 14px;
      color: #666;
    }

    /* Table */
    .table-container {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }

    th {
      background: #f9f9f9;
    }

    tr:hover {
      background: #f1f5ff;
    }

    .actions button {
      border: none;
      cursor: pointer;
      background: none;
      font-size: 18px;
      margin: 0 5px;
    }

    .add-btn {
      background: #4361ee;
      color: #fff;
      padding: 10px 15px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 15px;
    }

    .add-btn:hover {
      opacity: 0.9;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      width: 400px;
    }

    .modal-content h3 {
      margin-bottom: 15px;
    }

    .modal-content input {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .modal-content label {
      font-size: 14px;
      font-weight: 600;
      display: block;
      margin-top: 10px;
    }

    .modal-content button {
      margin-top: 15px;
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      background: #4361ee;
      color: #fff;
      cursor: pointer;
    }
  </style>
</head>

<body onload="loadPatients()">
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCd9uDRng_yMuMzqLhqrPs3Quht_lekbF0",
      authDomain: "medieye-8d798.firebaseapp.com",
      databaseURL: "https://medieye-8d798-default-rtdb.asia-southeast1.firebasedatabase.app/",
      projectId: "medieye-8d798",
      storageBucket: "medieye-8d798.firebasestorage.app",
      messagingSenderId: "967976625417",
      appId: "1:967976625417:web:00eed975b183e6d1e91fd8"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    function savePatient() {
      // Get input values
      const name = document.getElementById('name').value.trim();
      const age = document.getElementById('age').value;
      const disease = document.getElementById('disease').value.trim();
      const medicine = document.getElementById('medicine').value.trim();
      const email = document.getElementById('email_id').value.trim();
      const phno = document.getElementById('phno').value.trim();
      const morning = document.getElementById('morning').value || 0;
      const afternoon = document.getElementById('afternoon').value || 0;
      const evening = document.getElementById('evening').value || 0;
      const night = document.getElementById('night').value || 0;
      const days = document.getElementById('days').value;

      // Validation
      if (!name || !age || !medicine || !days || !disease) {
        alert('Please fill all required fields');
        return;
      }

      if (age <= 0 || days <= 0) {
        alert('Age and Days must be positive numbers');
        return;
      }

      // Create patient object
      const patientData = {
        name: name,
        age: parseInt(age),
        disease: disease,
        medicine: medicine,
        email: email,
        dosages: {
          morning: parseInt(morning),
          afternoon: parseInt(afternoon),
          evening: parseInt(evening),
          night: parseInt(night)
        },
        days: parseInt(days),
        createdAt: new Date()
      };

      // Save to Firebase with unique ID

      const updates = {};
      updates['/patients/' + phno] = patientData;

      return database.ref().update(updates)
        .then(() => {
          console.log("Data saved successfully!");
          loadPatients();
        })
        .catch((error) => {
          console.error("Data could not be saved." + error);
        });

    }

    function closeModal() {
      document.getElementById('patientModal').style.display = 'none';
    }

    function resetForm() {
      document.getElementById('name').value = '';
      document.getElementById('age').value = '';
      document.getElementById('disease').value = '';
      document.getElementById('email_id').value = '';
      document.getElementById('phno').value = '';
      document.getElementById('medicine').value = '';
      document.getElementById('morning').value = '';
      document.getElementById('afternoon').value = '';
      document.getElementById('evening').value = '';
      document.getElementById('night').value = '';
      document.getElementById('days').value = '';

      // Reset validation styles if you have any
      const modalTitle = document.getElementById('modalTitle');
      if (modalTitle.textContent === 'Edit Patient') {
        modalTitle.textContent = 'Add Patient';
        document.getElementById('saveBtn').onclick = () => savePatient();
      }
    }
    function loadPatients() {
      const tbody = document.querySelector('#patientTable tbody');
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Loading...</td></tr>';

      // üîç Read data from Firebase
      database.ref('patients').once('value')
        .then((snapshot) => {
          tbody.innerHTML = ''; // Clear loading message
          // console.log(snapshot);
          if (!snapshot.exists()) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No patients found</td></tr>';
            return;
          }

          const patients = snapshot.val();
          let rowCount = 0;

          // üîÅ Loop through all patients
          for (const patientId in patients) {
            const patient = patients[patientId];
            const row = createPatientRow(patient, patientId);
            tbody.appendChild(row);
            rowCount++;
          }

          // Show empty state if no rows
          if (rowCount === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No patients found</td></tr>';
          }
        })
        .catch((error) => {
          console.error('Error loading patients:', error);
          tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; color:red;">Error: ${error.message}</td></tr>`;
        });
    }

    // üß© Create table row for a patient
    function createPatientRow(patient, patientId) {
      const row = document.createElement('tr');

      // Calculate total dosages
      const dosages = patient.dosages || {};
      const totalDosages = (dosages.morning || 0) +
        (dosages.afternoon || 0) +
        (dosages.evening || 0) +
        (dosages.night || 0);

      // Format dosages per day display
      const dosageDisplay = [
        dosages.morning ? `M:${dosages.morning}` : '',
        dosages.afternoon ? `A:${dosages.afternoon}` : '',
        dosages.evening ? `E:${dosages.evening}` : '',
        dosages.night ? `N:${dosages.night}` : ''
      ].filter(Boolean).join(', ') || 'None';

      row.innerHTML = `
    <td>${escapeHtml(patient.name || 'N/A')}</td>
    <td>${patient.age || 'N/A'}</td>
    <td>${patient.disease}</td>
    <td>${patientId}</td>
    <td>${patient.email}</td>
    <td>${escapeHtml(patient.medicine || 'N/A')}</td>
    <td>${dosageDisplay}</td>
    <td>${patient.days || 'N/A'}</td>
    <td>${totalDosages * (patient.days || 0)}</td>
    <td>
      <button class="edit-btn" onclick="editPatient('${patientId}', ${JSON.stringify(patient).replace(/'/g, "\\'")})">Edit</button>
      <button class="delete-btn" onclick="deletePatient('${patientId}')">Delete</button>
    </td>
  `;

      return row;
    }

    function editPatient(patientId) {
      // Get patient data from Firebase
      database.ref('patients/' + patientId).once('value')
        .then((snapshot) => {
          if (!snapshot.exists()) {
            alert('Patient not found!');
            return;
          }

          const patient = snapshot.val();

          // Fill modal with existing patient data
          document.getElementById('name').value = patient.name || '';
          document.getElementById('age').value = patient.age || '';
          document.getElementById('disease').value = patient.disease || '';
          document.getElementById('medicine').value = patient.medicine || '';

          // Fill dosage fields (handle cases where dosages might not exist)
          const dosages = patient.dosages || {};
          document.getElementById('morning').value = dosages.morning || '';
          document.getElementById('afternoon').value = dosages.afternoon || '';
          document.getElementById('evening').value = dosages.evening || '';
          document.getElementById('night').value = dosages.night || '';

          document.getElementById('days').value = patient.days || '';

          // Update modal title to show "Edit Patient"
          document.getElementById('modalTitle').textContent = 'Edit Patient';

          // Change save button behavior to update instead of create
          const saveBtn = document.getElementById('saveBtn');
          saveBtn.textContent = 'Update';
          saveBtn.onclick = () => updatePatient(patientId);

          // Open the modal
          openModal();
        })
        .catch((error) => {
          console.error('Error fetching patient data:', error);
          alert('Error loading patient data: ' + error.message);
        });
    }

    // Helper function to update existing patient
    function updatePatient(patientId) {
      // Get input values
      const name = document.getElementById('name').value.trim();
      const age = document.getElementById('age').value;
      const disease = document.getElementById('disease').value;
      const medicine = document.getElementById('medicine').value.trim();
      const morning = document.getElementById('morning').value || 0;
      const afternoon = document.getElementById('afternoon').value || 0;
      const evening = document.getElementById('evening').value || 0;
      const night = document.getElementById('night').value || 0;
      const days = document.getElementById('days').value;

      // Validation
      if (!name || !age || !medicine || !days || !disease) {
        alert('Please fill all required fields');
        return;
      }

      if (age <= 0 || days <= 0) {
        alert('Age and Days must be positive numbers');
        return;
      }

      // Create updated patient object
      const updatedPatient = {
        name: name,
        age: parseInt(age),
        medicine: medicine,
        dosages: {
          morning: parseInt(morning),
          afternoon: parseInt(afternoon),
          evening: parseInt(evening),
          night: parseInt(night)
        },
        days: parseInt(days)
        // Note: We don't update createdAt timestamp for edits
      };

      // Update in Firebase
      database.ref('patients/' + patientId).update(updatedPatient)
        .then(() => {
          alert('Patient updated successfully!');
          closeModal();
          loadPatients(); // Refresh the table
        })
        .catch((error) => {
          console.error('Error updating patient:', error);
          alert('Error updating patient: ' + error.message);
        });
    }

    // üõ°Ô∏è Prevent XSS attacks
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // üóëÔ∏è Delete patient function
    function deletePatient(patientId) {
      if (confirm('Are you sure you want to delete this patient?')) {
        database.ref('patients/' + patientId).remove()
          .then(() => {
            alert('Patient deleted successfully!');
            loadPatients(); // Refresh table
          })
          .catch((error) => {
            console.error('Error deleting patient:', error);
            alert('Error deleting patient: ' + error.message);
          });
      }
    }

  </script>

  <!-- Sidebar -->
  <aside class="sidebar">
    <h2>MediEye</h2>
    <ul>
      <li><a href="dashboard.html">Dashboard</a></li>
      <li><a href="add-patient.html" class="active">Add Patient</a></li>
      <li><a href="login.html">Logout</a></li> <br><br>
      <li><a href="index.html"><b><u>Home</u></b></a></li>
    </ul>
  </aside>

  <!-- Main -->
  <main class="main">
    <!-- Summary cards -->
    

    <!-- Patient Table -->
    <div class="table-container">
      <button class="add-btn" onclick="openModal();">+ Add Patient</button>
      <table id="patientTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Age</th>
            <th>Disease</th>
            <th>Phone number</th>
            <th>Email</th>
            <th>Medicine</th>
            <th>Dosages/Day</th>
            <th>Days</th>
            <th>Total Dosages</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <!-- Modal for Add/Edit -->
  <div class="modal" id="patientModal">
    <div class="modal-content">
      <h3 id="modalTitle">Add Patient</h3>
      <input type="text" id="name" placeholder="Patient Name" required>
      <input type="number" id="age" placeholder="Age" required>
      <input type="text" id="email_id" placeholder="email id of patient" required>
      <input type="number" id="phno" placeholder="phone no. of patient" required>
      <input type="text" id="medicine" placeholder="Medicine Name" required>
      <input type="text" id="disease" placeholder="Patient's disease" required>
      <label>Dosages per day:</label>
      <input type="number" id="morning" placeholder="Morning" min="0" max="1">
      <input type="number" id="afternoon" placeholder="Afternoon" min="0" max="1">
      <input type="number" id="evening" placeholder="Evening" min="0" max="1">
      <input type="number" id="night" placeholder="Night" min="0" max="1">

      <label>Number of Days:</label>
      <input type="number" id="days" placeholder="Days of Medication" min="1">

      <button id="saveBtn" onclick="savePatient();closeModal();">Save</button>
    </div>
  </div>


  <script>
    function updateSummary() {
      document.getElementById("totalPatients").textContent = patients.length;
      document.getElementById("totalMedicines").textContent = [...new Set(patients.map(p => p.medicine))].length;
      document.getElementById("totalDosages").textContent = patients.reduce((acc, p) => acc + p.totalDosages, 0);
      document.getElementById("alerts").textContent = patients.filter(p => p.totalDosages > 3).length;
    }

    const modal = document.getElementById("patientModal");
    const tableBody = document.querySelector("#patientTable tbody");
    const modalTitle = document.getElementById("modalTitle");
    const saveBtn = document.getElementById("saveBtn");



    let patients = [];
    let editIndex = -1;

    function openModal(edit = false, index = -1) {
      modal.style.display = "flex";
      if (edit) {
        editIndex = index;
        const p = patients[index];
        document.getElementById("name").value = p.name;
        document.getElementById("age").value = p.age;
        document.getElementById("disease").value = p.disease;
        document.getElementById("medicine").value = p.medicine;
        document.getElementById("email_id").value = p.email_id;
        document.getElementById("phno").value = p.phno;
        document.getElementById("morning").value = p.morning;
        document.getElementById("afternoon").value = p.afternoon;
        document.getElementById("evening").value = p.evening;
        document.getElementById("night").value = p.night;
        document.getElementById("days").value = p.days;

        modalTitle.textContent = "Edit Patient";
        saveBtn.textContent = "Update";
      } else {
        editIndex = -1;
        document.querySelectorAll(".modal-content input").forEach(input => input.value = "");
        modalTitle.textContent = "Add Patient";
        saveBtn.textContent = "Save";
      }
    }

    window.onclick = e => { if (e.target == modal) modal.style.display = "none"; }






  </script>
</body>

</html>